{% extends "layouts/base.html" %}

{% block content %}
<div class="page-header">
  <div class="page-title-row">
    <h1>{{ computer.hostname }}</h1>
    <span class="status-badge status-{{ computer.status }}">
      <span class="status-dot status-{{ computer.status }}"></span>
      {{ computer.status | capitalize }}
    </span>
  </div>
  <p class="text-muted">
    IP: {{ computer.ip_address or 'Unknown' }} 
    {% if computer.agent_version %}| Agent: v{{ computer.agent_version }}{% endif %}
  </p>
</div>

{% if computer.status == 'offline' %}
<div class="alert alert-warning">
  <strong>Computer is offline.</strong> 
  Last seen: {{ computer.last_seen_at or 'Never' }}
  {% if computer.current_user %}
  <br>Last logged in user: {{ computer.current_user }}
  {% endif %}
</div>
{% else %}
<div class="info-box">
  <strong>Current Desktop User:</strong>
  {% if computer.current_user %}
    <span class="user-badge user-badge-lg">{{ computer.current_user }}</span>
  {% else %}
    <span class="text-muted">No one logged in</span>
  {% endif %}
</div>

{% endif %}

<div class="card">
  <div class="card-header">
    <h2>Users</h2>
    <div class="card-actions">
      {% if pendingCommands.length > 0 %}
      <span class="badge badge-warning">{{ pendingCommands.length }} pending command(s)</span>
      {% endif %}
      <span class="text-muted">Auto-refresh: 10s</span>
    </div>
  </div>
  
  <div 
    id="users-list"
    hx-get="/computers/{{ computer.id }}/users"
    hx-trigger="every 10s"
    hx-swap="innerHTML"
  >
    {% include "partials/users-list.html" %}
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2>Screenshots</h2>
    <span class="text-muted">Auto-refresh: 30s</span>
  </div>
  <div style="padding: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    <div style="flex: 1; min-width: 180px; text-align: center;">
      <div style="font-weight: 600; margin-bottom: 0.5rem;">Live</div>
      <img
        id="screenshot-live"
        src="/computers/{{ computer.id }}/screenshot"
        alt="Live"
        style="max-width: 100%; border-radius: 4px; display: block; margin: 0 auto;"
        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
        onload="this.style.display='block'; this.nextElementSibling.style.display='none';"
      >
      <span class="text-muted" style="display: none;">Not available</span>
    </div>
    <div id="history-slots" style="display: contents;"></div>
  </div>
</div>
<script>
  function refreshScreenshots() {
    var live = document.getElementById('screenshot-live');
    if (live) live.src = '/computers/{{ computer.id }}/screenshot?t=' + Date.now();

    fetch('/computers/{{ computer.id }}/screenshots')
      .then(function(r) { return r.json(); })
      .then(function(slots) {
        var container = document.getElementById('history-slots');
        container.innerHTML = '';
        slots.forEach(function(slot) {
          var div = document.createElement('div');
          div.style.cssText = 'flex: 1; min-width: 180px; text-align: center;';
          if (slot.data) {
            div.innerHTML = '<div style="font-weight: 600; margin-bottom: 0.5rem;">' + slot.label + '</div>' +
              '<img src="data:image/jpeg;base64,' + slot.data + '" style="max-width: 100%; border-radius: 4px; display: block; margin: 0 auto;">';
          } else {
            div.innerHTML = '<div style="font-weight: 600; margin-bottom: 0.5rem;">' + slot.label + '</div>' +
              '<span class="text-muted">Not available</span>';
          }
          container.appendChild(div);
        });
      });
  }

  refreshScreenshots();
  setInterval(refreshScreenshots, 30000);
</script>
{% endblock %}
