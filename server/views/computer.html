{% extends "layouts/base.html" %}

{% block content %}
<div class="page-header">
  <div class="page-title-row">
    <h1>{{ computer.hostname }}</h1>
    <span class="status-badge status-{{ computer.status }}">
      <span class="status-dot status-{{ computer.status }}"></span>
      {{ computer.status | capitalize }}
    </span>
  </div>
  <p class="text-muted">
    IP: {{ computer.ip_address or 'Unknown' }} 
    {% if computer.agent_version %}| Agent: v{{ computer.agent_version }}{% endif %}
  </p>
</div>

{% if computer.status == 'offline' %}
<div class="alert alert-warning">
  <strong>Computer is offline.</strong> 
  Last seen: {{ computer.last_seen_at or 'Never' }}
  {% if computer.current_user %}
  <br>Last logged in user: {{ computer.current_user }}
  {% endif %}
</div>
{% else %}
<div class="info-box">
  <strong>Current Desktop User:</strong>
  {% if computer.current_user %}
    <span class="user-badge user-badge-lg">{{ computer.current_user }}</span>
  {% else %}
    <span class="text-muted">No one logged in</span>
  {% endif %}
</div>

{% endif %}

<div class="card">
  <div class="card-header">
    <h2>Users</h2>
    <div class="card-actions">
      {% if pendingCommands.length > 0 %}
      <span class="badge badge-warning">{{ pendingCommands.length }} pending command(s)</span>
      {% endif %}
      <span class="text-muted">Auto-refresh: 10s</span>
    </div>
  </div>
  
  <div 
    id="users-list"
    hx-get="/computers/{{ computer.id }}/users"
    hx-trigger="every 10s"
    hx-swap="innerHTML"
  >
    {% include "partials/users-list.html" %}
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2>Screenshots</h2>
    <span class="text-muted">Live auto-refresh: 30s</span>
  </div>
  <div style="padding: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    {% set slots = [
      { name: 'recent', label: 'Live' },
      { name: 'min10',  label: '10 min ago' },
      { name: 'min30',  label: '30 min ago' },
      { name: 'min60',  label: '1 hour ago' },
      { name: 'min120', label: '2 hours ago' }
    ] %}
    {% for slot in slots %}
    <div style="flex: 1; min-width: 180px; text-align: center;">
      <div style="font-weight: 600; margin-bottom: 0.5rem;">{{ slot.label }}</div>
      <img
        {% if slot.name == 'recent' %}id="screenshot-live"{% endif %}
        src="/computers/{{ computer.id }}/screenshot?slot={{ slot.name }}"
        alt="{{ slot.label }}"
        style="max-width: 100%; border-radius: 4px; display: block; margin: 0 auto;"
        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
        onload="this.style.display='block'; this.nextElementSibling.style.display='none';"
      >
      <span class="text-muted" style="display: none;">Not available</span>
    </div>
    {% endfor %}
  </div>
</div>
<script>
  setInterval(function() {
    var img = document.getElementById('screenshot-live');
    if (img) {
      img.src = '/computers/{{ computer.id }}/screenshot?slot=recent&t=' + Date.now();
    }
  }, 30000);
</script>
{% endblock %}
